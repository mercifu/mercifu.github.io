---
layout:     post
title:      托管与非托管的区别
subtitle:   
date:       2019-06-04
author:     Sam
header-img: 
catalog: true
tags:
    - CLR
    - 托管代码
    - 非托管代码
    - .NET
---
### 托管与非托管的区别
上一篇在 MFC 项目中调用 WPF 组件中提到托管与非托管，所以这篇就打算说一下托管代码与非托管代码的区别

#### 1. 源代码到可执行文件

源代码到可执行文件的过程是一个翻译的过程，在这个过程中，编译器会根据目标机器的环境把高级语言翻译成可以适合在目标平台运行的机器码。

通用语言运行平台(CLR)是微软为 .NET 的虚拟机所选用的名称，比如 Java 的虚拟机名称为 JVM。CLR 是微软对通用语言架构的实现版本，它定义了一个代码运行的环境。开发人员使用高级语言编写程序，编译器将代码编译成微软的中间语言，CLR 的编译器 JIT 在托管执行环境下编译中间语言（IL）使之成为本地可执行的代码，在运行中提供多个重要服务，例如自动内存管理、安全边界、类型安全，等等。

![](..\img\post_img\Common_Language_Runtime_diagram.png)


#### 2. 托管代码

 编译器把C#代码编译成中间语言(IL)，将中间语言封装在一个叫程序集(assembly)的文件中。托管代码在公共语言运行库(CLR)中运行。这个运行库给运行代码提供各种各样的服务，通常来说，CLR 会加载和验证程序集，以此来保证中间语言的正确性。当某些方法被调用的时候，运行库把具体的方法编译成适合本地计算机运行的机械码，然后会把编译好的机械码缓存起来，以备下次调用(这就是即时编译)。随着程序集的运行，运行库会持续地提供各种服务，例如安全，内存管理，线程管理等等。这个程序被“托管”在运行库中。
 
 Visual Basic, C#, F# 和其他 .NET 语言只能产生托管代码。如果你用这类语言写程序，那么所产生的代码就是托管代码。

#### 3. 非托管代码

非托管代码直接编译成目标计算机的机械码，这些代码只能运行在编译出它们的平台上，或者是其它相同处理器或者几乎一样处理器的平台上。非托管代码不能享受一些运行库所提供的服务，例如安全和内存管理等。如果非托管代码需要进行内存管理等服务，就必须显式地调用操作系统的接口，通常来说，它们会直接调用 Windows SDK 所提供的 API 来实现。就最近的情况来看，非托管程序会通过 COM 接口来获取操作系统服务。跟 Visual Studio 平台的其他编程语言不一样，Visual C++ 可以创建非托管程序。

#### 4. 区别

1. 托管代码是一种中间语言，运行在CLR上；

    非托管代码被编译为机器码，运行在机器上。

2. 托管代码独立于平台和语言，能更好的实现不同语言平台之间的兼容；

    非托管代码依赖于平台和语言。

3. 托管代码可享受CLR提供的服务（如安全检测、垃圾回收等），不需要自己完成这些操作；

    非托管代码需要自己提供安全检测、垃圾回收等操作。


参考
[https://blog.51cto.com/gauyanm/581107](https://blog.51cto.com/gauyanm/581107)
[http://blog.sina.com.cn/s/blog_3e51bb390102vv6b.html](http://blog.sina.com.cn/s/blog_3e51bb390102vv6b.html)

